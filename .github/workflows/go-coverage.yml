name: Go coverage report

on:
    workflow_run:
        workflows:
            - Go quality checks
        types:
            - completed

permissions:
    contents: read
    pull-requests: write
    actions: read

jobs:
    coverage:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.event == 'pull_request' && !startsWith(github.event.workflow_run.head_branch, 'release-please') }}
        steps:
            - uses: actions/checkout@v6

            - name: Download coverage artifact
              uses: actions/download-artifact@v7
              with:
                  name: go-coverage
                  path: coverage
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  run-id: ${{ github.event.workflow_run.id }}

            - uses: actions/setup-go@v6
              with:
                  go-version: "stable"

            - name: Generate coverage markdown
              shell: bash
              run: |
                  go tool cover -func=coverage/coverage.out > cover_func.txt
                  {
                      echo "### Go Coverage Report"
                      echo ""
                      echo "| Package | Coverage |"
                      echo "|---------|----------|"
                      grep -v total cover_func.txt | awk '{print "| " $1 " | " $NF " |"}'
                      total=$(grep total cover_func.txt | awk '{print $3}')
                      echo ""
                      echo "**Total coverage:** $total"
                  } > coverage.md

            - name: coverage output
              id: coverage
              shell: bash
              run: |
                  {
                      echo "body<<EOF"
                      cat coverage.md
                      echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: merge request id
              id: merge-request
              shell: bash
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  id=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }} --jq '.pull_requests[0].number')
                  echo "number=$id" >> "$GITHUB_OUTPUT"

            - name: coverage report
              uses: marocchino/sticky-pull-request-comment@v2
              env:
                  COMMIT: ${{ github.event.workflow_run.head_sha }}
              with:
                  number: ${{ steps.merge-request.outputs.number }}
                  header: Go Coverage Report
                  message: |
                      [`${COMMIT:0:7}`](https://github.com/${{ github.repository }}/commit/${{ github.event.workflow_run.head_sha }})

                      ${{ steps.coverage.outputs.body }}
